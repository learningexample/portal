<VirtualHost *:80>
    ServerName localhost
    
    # Improved proxy timeout settings to prevent 502 errors
    ProxyTimeout 300
    ProxyBadHeader Ignore
    
    # Static assets directory
    Alias /assets/ /var/www/html/assets/
    <Directory /var/www/html/assets/>
        Require all granted
        Options Indexes FollowSymLinks
        AllowOverride None
        
        # Add caching headers for static assets
        <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg)$">
            Header set Cache-Control "max-age=86400, public"
        </FilesMatch>
    </Directory>
    
    # Route requests to portal-1
    ProxyPass /portal-1/ http://ai-portal:8050/portal-1/ timeout=300 connectiontimeout=10 retry=1
    ProxyPassReverse /portal-1/ http://ai-portal:8050/portal-1/
    
    # Route requests to portal-2
    ProxyPass /portal-2/ http://ai-portal-tabbed:8050/portal-2/ timeout=300 connectiontimeout=10 retry=1
    ProxyPassReverse /portal-2/ http://ai-portal-tabbed:8050/portal-2/
    
    # Route requests to AppStore
    ProxyPass /AppStore/ http://ai-portal-bysection:8050/AppStore/ timeout=300 connectiontimeout=10 retry=1
    ProxyPassReverse /AppStore/ http://ai-portal-bysection:8050/AppStore/
    
    # Route requests to portal-4 (Apple App Store style)
    ProxyPass /portal-4/ http://ai-portal-appstore:8050/portal-4/ timeout=300 connectiontimeout=10 retry=1
    ProxyPassReverse /portal-4/ http://ai-portal-appstore:8050/portal-4/
    
    # Redirect root to portal-1
    RedirectMatch ^/$ /portal-1/
    
    # Enable proxy settings
    ProxyPreserveHost On
    
    # For any other requests, try the original portal (make this the last rule)
    ProxyPass / http://ai-portal:8050/ timeout=300 connectiontimeout=10 retry=1
    ProxyPassReverse / http://ai-portal:8050/
    
    # Log additional proxy information to help diagnose issues
    LogLevel warn proxy:info
    
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>